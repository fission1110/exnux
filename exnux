#!/bin/bash
CMD="$1"
# echo "/tmp/cores/core.%e.%p.%h.%t" > /proc/sys/kernel/core_pattern
export DOCKER_BUILDKIT=1
export XAUTHORITY=${XAUTHORITY:-$HOME/.Xauthority}
export DISPLAY=${DISPLAY:-:0}
export USERNAME=nonroot
SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
cd $SCRIPT_DIR
mkdir -p $SCRIPT_DIR/cache
mkdir -p $SCRIPT_DIR/cache/.cache/radare2
mkdir -p $SCRIPT_DIR/cache/treesitter/
mkdir -p $SCRIPT_DIR/cache/treesitter/parser
mkdir -p $SCRIPT_DIR/cache/treesitter/parser-info
mkdir -p $SCRIPT_DIR/cache/.msf4
touch -a $SCRIPT_DIR/cache/.zsh_history
touch -a $SCRIPT_DIR/cache/.bash_history
touch -a $SCRIPT_DIR/cache/.gdb_history
touch -a $SCRIPT_DIR/cache/.cache/radare2/history
touch -a $SCRIPT_DIR/cache/.msf4/history
case "$CMD" in
    init)
        sudo apt-get install docker.io git
        sudo curl -SL https://github.com/docker/compose/releases/download/v2.4.1/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
    ;;
    build)
        docker-compose build exnux
    ;;
    build-apt-cache)
        docker-compose create apt-cacher-ng
        docker-compose start apt-cacher-ng
        docker-compose build --build-arg APT_PROXY="http://172.17.0.1:3142" exnux
        docker-compose stop apt-cacher-ng
    ;;
    start)
        docker-compose run exnux /usr/bin/byobu
    ;;
    start-gui)
        docker-compose run exnux alacritty --command byobu
    ;;
    msf-postgres)
        docker-compose create msf-postgres
        docker-compose start msf-postgres
    ;;
    net)
        docker network create "$NAME-net" 2> /dev/null
    ;;
    clean)
        docker-compose down
    ;;
    distclean)
        $0 clean
        git clean -fdx :dotfiles
    ;;
    *)
        echo "$0 build|start|clean|distclean|build-apt-cache|msf-postgres|start-home-mount"
    ;;
esac
